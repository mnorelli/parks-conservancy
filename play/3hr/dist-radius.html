<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <style>

      body {
        font-family: "Helvetica Neue", Helvetica, arial, sans-serif;
        margin: 0;
        padding: 0;
      }

      #content {

      }

    </style>
  </head>

  <body>

    <div id="content"></div>

    <script src="js/d3.v3.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&key=AIzaSyAbYZns2R_4Jg8zUsyLYNOuxqgYf1Ymacs"></script>

    <script>

      var content = d3.select("#content");

      var margin = 50;
      content.style("width", window.innerWidth + "px")
             .style("height", window.innerHeight + "px");

      google.maps.visualRefresh = true;
      var center = new google.maps.LatLng(37.7750, -122.4183);
      // var center = new google.maps.LatLng(0,0);
      var opts = {
        zoom: 12,
        center: center
        // mapTypeId: google.maps.MapTypeId.TERRAIN
      };
      var map = new google.maps.Map(document.getElementById("content"), opts);

      var display = {
        strokeWeight: 0,
        fillColor: '#ff0000',
        fillOpacity: 0.7,
        map: map,
        center: center,
        radius: 300
      };
      var circle = new google.maps.Circle(display);

      d3.csv("data/locations.csv", function(err, locations) {
        // console.log("locations:", locations);
        locations = locations.filter(function(loc) {
          var t = loc.type;
          return t === "Meeting Place" 
              || t === "Park" 
              || t === "Trailhead" 
              || t === "Beach"
              || t === "Site of Interest"
              || t === "Overlook";
        });

        var origin = center; //[center.jb, center.kb];
        var distances = [];
        locations.forEach(function(location, i) {
          var coords = [location.Y, location.X].map(Number);
          var destination = new google.maps.LatLng(coords[0], coords[1]);
          // var distance = getDistance(origin, destination);
          var distance = distHaversine(origin, destination);
          distances.push([distance, i]);
        });
        distances.sort(function(a,b) { return d3.ascending(a[0], b[0]); });
        // distances = distances.slice(0, 30);
        // console.log("distances:", distances);

        var extent = d3.extent(distances.map(function(d) { return d[0]; }));
        var hue = d3.scale.linear().domain(extent).range([80, 0]);

        var radials = d3.range(2, 100, 2).reverse(),
            max_points_in_radial = 0;

        radials.forEach(function(radial) {
          var in_circle = distances.filter(function(point) {
            return point[0] < radial * 1000 && point[0] > (radial - 2) * 1000;
          });
          max_points_in_radial = in_circle.length > max_points_in_radial ? in_circle.length : max_points_in_radial;
        });

        var radial_hue = d3.scale.linear().domain([0, max_points_in_radial]).range([200, 360]);

        radials.forEach(function(radial) {
          var in_circle = distances.filter(function(point) {
            return point[0] < radial * 1000 && point[0] > (radial - 2) * 1000;
          });
          // console.log(radial + " in_circle:", in_circle.length);
          var style = {
            strokeWeight: 2,
            strokeColor: "hsl(" + radial_hue(in_circle.length) + ", 100%, 70%)",
            strokeOpacity: in_circle.length > 0 ? 1 : 0,
            // strokeColor: "#000000",
            // fillColor: "hsl(" + radial_hue(in_circle.length) + ", 100%, 70%)",
            // fillColor: "none",
            fillOpacity: 0,
            map: map,
            center: center,
            radius: radial * 1000 // meters -> km
          };
          var circle = new google.maps.Circle(style);

          in_circle.forEach(function(point) {
            var distance = point[0],
                data = locations[point[1]];

            var style = {
              strokeWeight: 1,
              strokeColor: "#000000",
              // fillColor: "hsl(" + hue(distance) + ", 100%, 70%)",
              fillColor: "hsl(" + radial_hue(in_circle.length) + ", 100%, 70%)",
              fillOpacity: 0.7,
              map: map,
              center: new google.maps.LatLng(+data.Y, +data.X),
              radius: 100
            };
            var circle = new google.maps.Circle(style);
          });
        });

      //   distances.forEach(function(dist) {
      //     var distance = dist[0],
      //         data = locations[dist[1]];

      //     var style = {
      //       strokeWeight: 1,
      //       strokeColor: "#000000",
      //       fillColor: "hsl(" + hue(distance) + ", 100%, 70%)",
      //       fillOpacity: 0.7,
      //       map: map,
      //       center: new google.maps.LatLng(+data.Y, +data.X),
      //       radius: 200
      //     };
      //     var circle = new google.maps.Circle(style);
      //   });
      });

      function deg2rad(degrees) {
        return degrees * (Math.PI / 180);
      }

      rad = function(x) {return x*Math.PI/180;}

      distHaversine = function(p1, p2) {
        var R = 6371; // earth's mean radius in km
        var dLat  = rad(p2.lat() - p1.lat());
        var dLong = rad(p2.lng() - p1.lng());

        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(rad(p1.lat())) * Math.cos(rad(p2.lat())) * Math.sin(dLong/2) * Math.sin(dLong/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var d = R * c;

        return d * 1000; // km -> meters
      }

    </script>

  </body>
</html>