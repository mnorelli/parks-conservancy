<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <style>

      body,
      svg {
        margin: 0;
        padding: 0;
      }

      div.trail-data {
        background: #000;
        margin-bottom: 20px;
      }

      div.trail-metadata {
        display: inline-block;
        background: #ccc;
        width: 50%;
      }

      div.full-trail-data {
        background: red;
        height: 0;
        display: hidden;
      }

      div.trail-metadata-header h3 {
        display: inline;
      }

      span.trail-metadata-header-duration {
        text-transform: uppercase;
        display: inline;
        margin-left: 5px;
      }

      div.profile-sample {
        display: inline-block;
        background: pink;
        width: 50%;
        vertical-align: top;
      }

      ul,
      ul li {
        display: inline;
        margin-left: 0;
        padding-left: 0;
      }

      img.profile-thumb {
        width: 50%;
        height: 50%;
      }

    </style>
  </head>
  <body>


    <div id="trails-listing-header">
      <h2>Browse Trails</h2>
      <a class="browse-link" href="#">All</a> /
      <a class="browse-link" href="#">Easy</a> /
      <a class="browse-link" href="#">Moderate</a> /
      <a class="browse-link" href="#">Strenuous</a> 
    </div>
    <div id="trails-listing"></div>

    <script src="js/d3.v3.js"></script>
    <script>


      // var trips = [
      //   1287, 1424, 1431, 89, 45, 1297, 216, 
      //   1338, 1446, 1295, 140, 1333, 63, 1448, 
      //   1449, 263, 1433
      // ];
      // var numTrips = trips.length;

      // trips.forEach(function(tripId) {
      //   var elevationProfileFile = "trips-elevation/" + tripId + ".json";
      //   d3.json()
      // });

      // load the metadata for the stored trips
      d3.json("index.json", function(err, index) {
        if (err) {
          console.log(err); 
          return;
        }
        var container = d3.select("#trails-listing");
        var trailsList = container.selectAll("div.trail-data")
          .data(index.profiles)
        .enter().append("div")
          .attr("id", function(d) { return "trip-container-" + d.id; })
          .classed("trail-data", true)
          .on("click", trailDataClick);

        // duration, intensity, name, length_miles, id


        var meta = trailsList.append("div")
          .classed("trail-metadata", true);

        var metaHeader = meta.append("div")
          .classed("trail-metadata-header", true);

        metaHeader.append("h3")
          .text(function(d) { return d.name; });

        metaHeader.append("span")
          .classed("trail-metadata-header-duration", true)
          .text(function(d) { return d.duration; });

        meta.append("ul")
          .selectAll("li")
            .data(function(d) { 
              // XXX middle elevation value needs to be preprocessed on the backend
              return [
                [d.length_miles, "miles"], 
                ["[image]", 0, "elevation change"], 
                [d.duration]
              ]; 
            })
          .enter().append("li")
            .attr("class", function(d, i) { 
              return (i < 2) ? "light" : "";
            })
            .text(function(d) { return d.join(" "); });

        var profileSample = trailsList.append("div")
          .classed("profile-sample", true)
          // XXX FIX: need to do error checking on images
          .append("img")
            .classed("profile-thumb", true)
            .attr("src", function(d) { return "png/" + d.id + ".png"; });
          // .html(function(d) { 
          //   return "[profile image]";
          // });
      });

      // var x; // debug
      function trailDataClick(trailData) {
        // what happens when you click the trail listing

        var that = d3.select(this);
        // x = that;

        if (that.classed("open")) {
          // console.log("registered as open, should close", that.node());
          closeFullTrail(that);
          return;
        }

        // XXX FIX: should save some of the data on the front so we don't reload it
        // every single time
        d3.json("trips/" + trailData.id + "-elevation.json", function(err, fullTrailData) {
          if (err) {
            console.log(err);
            return;
          }
          console.log("loaded " + trailData.id, fullTrailData);
          displayFullTrail(fullTrailData, that);
        }); 
      }

      function closeFullTrail(container) {
        var displayContainer = container.select(".full-trail-data");
        displayContainer
          .html("")
          .transition().duration(200)
            .style("height", "0px")
            .remove()
            .each("end", function() {
              container.classed("open", false);
            });
      }

      function displayFullTrail(fullTrailData, container) {
        container.classed("open", true);

        var displayContainer = container.append("div")
          .classed("full-trail-data", true);

        // XXX DO ALL MAPMAKING STUFF HERE

        displayContainer.text("i'm open");

        // END ALL MAPMAKING STUFF

        displayContainer.transition().duration(200)
          .style("height", "200px");
          // .classed("open", true);



      }

    </script>

  </body>
</html>